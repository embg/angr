jobs:
- job: Build
  pool: linux-docker
  container:
    image: angr/ci:1
    options: --cap-add=SYS_PTRACE
  steps:
  - script: /root/scripts/azure-build.sh

  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: "build_archive"
      targetPath: ./build.tar.gz

- job: Lint
  pool: linux-docker
  container:
    image: angr/ci:1
    options: --cap-add=SYS_PTRACE
  dependsOn: Build
  condition: succeeded()
  steps:
  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: "build_archive"
      targetPath: .

  - script: /root/scripts/azure-lint.sh

- job: Test
  pool: linux-docker
  container:
    image: angr/ci:1
    options: --cap-add=SYS_PTRACE
  dependsOn: Build
  condition: succeeded()
  variables:
    NUM_WORKERS: 6
  strategy:
    maxParallel: 6
    matrix:
      worker_0:
        WORKER: 0
      worker_1:
        WORKER: 1
      worker_2:
        WORKER: 2
      worker_3:
        WORKER: 3
      worker_4:
        WORKER: 4
      worker_5:
        WORKER: 5
  steps:
  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: "build_archive"
      targetPath: .

  - script: /root/scripts/azure-test.sh

  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testRunner: "JUnit"
      testResultsFiles: "build/results/*.xml"
      mergeTestResults: true

